<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>10秒クリックチャレンジ | Rakia Games</title>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9155865843934014"
         crossorigin="anonymous"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-dark: #0d0d0d;
            --bg-card: #1a1a1a;
            --bg-card-hover: #252525;
            --accent: #ff6b35;
            --accent-dim: rgba(255, 107, 53, 0.15);
            --text: #e0e0e0;
            --text-dim: #888;
            --border: #2a2a2a;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #ef4444;
        }

        body {
            font-family: 'Segoe UI', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: var(--bg-dark);
            min-height: 100vh;
            color: var(--text);
        }

        /* ヘッダー */
        header {
            background: var(--bg-dark);
            padding: 0 40px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            height: 60px;
            gap: 50px;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.9rem;
        }

        .back-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.15s;
        }

        .back-link:hover {
            color: #fff;
        }

        /* 広告付きレイアウト */
        .page-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            padding: 40px 20px;
            min-height: calc(100vh - 60px);
        }

        .ad-side {
            width: 160px;
            min-height: 600px;
            background: var(--bg-card);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 20px;
            position: sticky;
            top: 80px;
            border: 1px solid var(--border);
        }

        .ad-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        @media (max-width: 900px) {
            .ad-side {
                display: none;
            }
            .page-wrapper {
                padding: 20px 10px;
            }
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 420px;
            width: 100%;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
            color: #fff;
            font-weight: 600;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 24px 0;
            gap: 12px;
        }

        .stat-box {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 16px 24px;
            flex: 1;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .timer {
            color: var(--success);
            transition: color 0.3s;
        }

        .timer.warning {
            color: var(--warning);
        }

        .timer.danger {
            color: var(--danger);
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .click-count {
            color: var(--accent);
        }

        .click-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            background: var(--bg-card);
            color: var(--accent);
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            margin: 30px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }

        .click-button:hover {
            background: var(--accent-dim);
        }

        .click-button:active {
            transform: scale(0.95);
            background: var(--accent);
            color: #fff;
        }

        .click-button:disabled {
            border-color: var(--border);
            color: var(--text-dim);
            cursor: not-allowed;
        }

        .click-button.clicked {
            animation: clickPop 0.1s ease-out;
        }

        @keyframes clickPop {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .control-button {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 14px 40px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.15s;
        }

        .control-button:hover {
            filter: brightness(1.1);
        }

        .control-button:active {
            transform: scale(0.98);
        }

        .control-button:disabled {
            background: var(--bg-card);
            color: var(--text-dim);
            cursor: not-allowed;
        }

        .control-button.secondary {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .control-button.secondary:hover {
            background: var(--accent-dim);
        }

        .best-score {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .best-score-label {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .best-score-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--warning);
        }

        .result-screen {
            display: none;
        }

        .result-screen.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .final-score {
            font-size: 4rem;
            font-weight: bold;
            color: var(--accent);
            margin: 20px 0;
        }

        .cps {
            font-size: 1rem;
            color: var(--text-dim);
            margin-bottom: 20px;
        }

        .new-record {
            display: none;
            color: var(--warning);
            font-size: 1.2rem;
            font-weight: bold;
            margin: 15px 0;
            animation: newRecordPulse 1s ease-in-out infinite;
        }

        .new-record.show {
            display: block;
        }

        @keyframes newRecordPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .hidden {
            display: none !important;
        }

        /* ランキング */
        .ranking-section {
            margin-top: 24px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .ranking-title {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .ranking-list {
            list-style: none;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin: 4px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .ranking-item:nth-child(1) {
            background: rgba(255, 215, 0, 0.1);
        }

        .ranking-item:nth-child(2) {
            background: rgba(192, 192, 192, 0.1);
        }

        .ranking-item:nth-child(3) {
            background: rgba(205, 127, 50, 0.1);
        }

        .ranking-rank {
            font-size: 1rem;
            font-weight: bold;
            width: 30px;
            text-align: center;
            color: var(--text-dim);
        }

        .ranking-item:nth-child(1) .ranking-rank { color: #fcd34d; }
        .ranking-item:nth-child(2) .ranking-rank { color: #d1d5db; }
        .ranking-item:nth-child(3) .ranking-rank { color: #d97706; }

        .ranking-name {
            flex: 1;
            text-align: left;
            margin-left: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-score {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent);
        }

        .ranking-loading, .ranking-empty {
            color: var(--text-dim);
            padding: 20px;
            font-size: 0.85rem;
        }

        /* モーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            max-width: 350px;
            width: 90%;
            border: 1px solid var(--border);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .login-status {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 12px;
            text-align: center;
        }

        .login-status:empty {
            display: none;
        }

        .modal input {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-dark);
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal input::placeholder {
            color: var(--text-dim);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-buttons button {
            padding: 12px 24px;
            font-size: 0.95rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.15s;
        }

        .btn-submit {
            background: var(--accent);
            color: white;
        }

        .btn-submit:hover {
            filter: brightness(1.1);
        }

        .btn-cancel {
            background: var(--bg-dark);
            color: var(--text-dim);
            border: 1px solid var(--border);
        }

        .btn-cancel:hover {
            color: #fff;
        }

        .register-status {
            font-size: 0.85rem;
            margin-top: 10px;
            min-height: 20px;
        }

        .register-status.success {
            color: var(--success);
        }

        .register-status.error {
            color: var(--danger);
        }

        @media (max-width: 600px) {
            header {
                padding: 0 16px;
            }
            .header-content {
                gap: 16px;
            }
            h1 {
                font-size: 1.3rem;
            }
            .click-button {
                width: 180px;
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="../" class="logo">
                <span class="logo-icon">R</span>
                Rakia Games
            </a>
            <a href="../" class="back-link">← ゲーム一覧に戻る</a>
        </div>
    </header>

    <div class="page-wrapper">
        <!-- 左サイド広告 -->
        <aside class="ad-side ad-left">
            <div class="ad-label">広告</div>
            <ins class="adsbygoogle"
                 style="display:inline-block;width:160px;height:600px"
                 data-ad-client="ca-pub-9155865843934014"
                 data-ad-slot="LEFT_AD_SLOT"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </aside>

        <!-- メインコンテンツ -->
        <div class="container">
            <h1>10秒クリックチャレンジ</h1>

            <!-- 待機画面 -->
            <div id="startScreen">
                <p style="color: var(--text-dim); margin: 16px 0;">10秒間で何回クリックできるかな？</p>
                <button class="control-button" id="startButton">スタート</button>
                <div class="best-score">
                    <div class="best-score-label">自己ベスト</div>
                    <div class="best-score-value" id="bestScoreStart">0 回</div>
                </div>

                <div class="ranking-section">
                    <div class="ranking-title">ランキング TOP10</div>
                    <ul class="ranking-list" id="rankingListStart">
                        <li class="ranking-loading">読み込み中...</li>
                    </ul>
                </div>
            </div>

            <!-- ゲーム画面 -->
            <div id="gameScreen" class="hidden">
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">残り時間</div>
                        <div class="stat-value timer" id="timer">10.0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">クリック数</div>
                        <div class="stat-value click-count" id="clickCount">0</div>
                    </div>
                </div>
                <button class="click-button" id="clickButton">
                    クリック！
                </button>
                <div class="cps">CPS: <span id="liveCps">0.0</span></div>
            </div>

            <!-- 結果画面 -->
            <div id="resultScreen" class="hidden">
                <div class="result-screen show">
                    <p style="font-size: 1rem; color: var(--text-dim);">結果</p>
                    <div class="final-score" id="finalScore">0</div>
                    <div class="cps">CPS (クリック/秒): <span id="finalCps">0.0</span></div>
                    <div class="new-record" id="newRecord">NEW RECORD!</div>
                    <div class="best-score">
                        <div class="best-score-label">自己ベスト</div>
                        <div class="best-score-value" id="bestScoreResult">0 回</div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="control-button secondary" id="registerButton" style="display: none;">ランキング登録</button>
                    </div>
                    <div class="register-status" id="registerStatus"></div>
                    <button class="control-button" id="retryButton" style="margin-top: 10px;">もう一度</button>

                    <div class="ranking-section">
                        <div class="ranking-title">ランキング TOP10</div>
                        <ul class="ranking-list" id="rankingListResult">
                            <li class="ranking-loading">読み込み中...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右サイド広告 -->
        <aside class="ad-side ad-right">
            <div class="ad-label">広告</div>
            <ins class="adsbygoogle"
                 style="display:inline-block;width:160px;height:600px"
                 data-ad-client="ca-pub-9155865843934014"
                 data-ad-slot="RIGHT_AD_SLOT"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </aside>
    </div>

    <!-- 名前入力モーダル -->
    <div class="modal-overlay" id="nameModal">
        <div class="modal">
            <h2>名前を入力</h2>
            <p class="login-status" id="loginStatus"></p>
            <input type="text" id="playerName" placeholder="ニックネーム" maxlength="20" autocomplete="off">
            <div class="modal-buttons">
                <button class="btn-cancel" id="cancelRegister">キャンセル</button>
                <button class="btn-submit" id="submitScore">登録</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, orderBy, limit, getDocs, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqlOPEvdpg8rlgrT0bt1cUzRH2jKtfRqw",
            authDomain: "rakiagames.firebaseapp.com",
            projectId: "rakiagames",
            storageBucket: "rakiagames.firebasestorage.app",
            messagingSenderId: "988630075198",
            appId: "1:988630075198:web:b3eb7f4767d29cbce4ce6f",
            measurementId: "G-M44D45510V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ログインユーザー情報
        let currentUser = null;
        let userProfile = null;

        // ユーザープロフィール取得
        async function getUserProfile(uid) {
            try {
                const docRef = doc(db, 'users', uid);
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) {
                console.error('プロフィール取得エラー:', error);
                return null;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                userProfile = await getUserProfile(user.uid);
            } else {
                userProfile = null;
            }
        });

        const GAME_DURATION = 10000;
        const RANKING_CACHE_DURATION = 15 * 60 * 1000; // 15分
        let clickCount = 0;
        let startTime = null;
        let gameActive = false;
        let currentScore = 0;
        let scoreRegistered = false;

        // ランキングキャッシュ
        function getRankingCache() {
            try {
                const cached = localStorage.getItem('rankingCache');
                if (!cached) return null;
                const { data, timestamp } = JSON.parse(cached);
                if (Date.now() - timestamp > RANKING_CACHE_DURATION) {
                    return null; // 期限切れ
                }
                return data;
            } catch {
                return null;
            }
        }

        function setRankingCache(data) {
            localStorage.setItem('rankingCache', JSON.stringify({
                data,
                timestamp: Date.now()
            }));
        }

        function clearRankingCache() {
            localStorage.removeItem('rankingCache');
        }

        const startScreen = document.getElementById('startScreen');
        const gameScreen = document.getElementById('gameScreen');
        const resultScreen = document.getElementById('resultScreen');
        const startButton = document.getElementById('startButton');
        const clickButton = document.getElementById('clickButton');
        const retryButton = document.getElementById('retryButton');
        const timerDisplay = document.getElementById('timer');
        const clickCountDisplay = document.getElementById('clickCount');
        const liveCpsDisplay = document.getElementById('liveCps');
        const finalScoreDisplay = document.getElementById('finalScore');
        const finalCpsDisplay = document.getElementById('finalCps');
        const newRecordDisplay = document.getElementById('newRecord');
        const bestScoreStart = document.getElementById('bestScoreStart');
        const bestScoreResult = document.getElementById('bestScoreResult');
        const registerButton = document.getElementById('registerButton');
        const registerStatus = document.getElementById('registerStatus');
        const nameModal = document.getElementById('nameModal');
        const playerNameInput = document.getElementById('playerName');
        const submitScoreButton = document.getElementById('submitScore');
        const cancelRegisterButton = document.getElementById('cancelRegister');
        const rankingListStart = document.getElementById('rankingListStart');
        const rankingListResult = document.getElementById('rankingListResult');

        function getBestScore() {
            return parseInt(localStorage.getItem('clickChallengeBestScore') || '0', 10);
        }

        function setBestScore(score) {
            localStorage.setItem('clickChallengeBestScore', score.toString());
        }

        function getLastName() {
            return localStorage.getItem('clickChallengeLastName') || '';
        }

        function setLastName(name) {
            localStorage.setItem('clickChallengeLastName', name);
        }

        function updateBestScoreDisplay() {
            const best = getBestScore();
            bestScoreStart.textContent = `${best} 回`;
            bestScoreResult.textContent = `${best} 回`;
        }

        function showScreen(screen) {
            startScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        async function loadRanking(force = false) {
            // キャッシュをチェック（強制更新でなければ）
            if (!force) {
                const cached = getRankingCache();
                if (cached) {
                    console.log('ランキング: キャッシュから取得');
                    return cached;
                }
            }

            try {
                console.log('ランキング: Firebaseから取得');
                const q = query(
                    collection(db, 'rankings'),
                    orderBy('score', 'desc'),
                    limit(10)
                );
                const snapshot = await getDocs(q);
                const rankings = [];
                snapshot.forEach(doc => {
                    rankings.push(doc.data());
                });
                // キャッシュに保存
                setRankingCache(rankings);
                return rankings;
            } catch (error) {
                console.error('ランキング取得エラー:', error);
                return null;
            }
        }

        function renderRanking(rankings, listElement) {
            if (rankings === null) {
                listElement.innerHTML = '<li class="ranking-empty">取得に失敗しました</li>';
                return;
            }
            if (rankings.length === 0) {
                listElement.innerHTML = '<li class="ranking-empty">まだ記録がありません</li>';
                return;
            }

            listElement.innerHTML = rankings.map((r, i) => `
                <li class="ranking-item">
                    <span class="ranking-rank">${i + 1}</span>
                    <span class="ranking-name">${escapeHtml(r.name)}</span>
                    <span class="ranking-score">${r.score} 回</span>
                </li>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateRankings(force = false) {
            const rankings = await loadRanking(force);
            renderRanking(rankings, rankingListStart);
            renderRanking(rankings, rankingListResult);
        }

        async function submitScore(name, score) {
            try {
                if (currentUser && userProfile) {
                    // ログインユーザー: UIDをドキュメントIDとして使用（1人1スコア）
                    const docRef = doc(db, 'rankings', currentUser.uid);
                    const existingDoc = await getDoc(docRef);

                    if (existingDoc.exists()) {
                        // 既存スコアより高い場合のみ更新
                        if (score > existingDoc.data().score) {
                            await setDoc(docRef, {
                                name: userProfile.displayName,
                                score: score,
                                uid: currentUser.uid,
                                timestamp: serverTimestamp()
                            });
                        } else {
                            // スコアが低い場合は更新しない（成功扱い）
                            return true;
                        }
                    } else {
                        // 新規登録
                        await setDoc(docRef, {
                            name: userProfile.displayName,
                            score: score,
                            uid: currentUser.uid,
                            timestamp: serverTimestamp()
                        });
                    }
                } else {
                    // 未ログインユーザー: 従来通り
                    await addDoc(collection(db, 'rankings'), {
                        name: name.slice(0, 20),
                        score: score,
                        timestamp: serverTimestamp()
                    });
                }
                return true;
            } catch (error) {
                console.error('スコア登録エラー:', error);
                return false;
            }
        }

        function startGame() {
            clickCount = 0;
            gameActive = true;
            scoreRegistered = false;
            startTime = performance.now();

            clickCountDisplay.textContent = '0';
            timerDisplay.textContent = '10.0';
            timerDisplay.className = 'stat-value timer';
            liveCpsDisplay.textContent = '0.0';
            clickButton.disabled = false;
            registerButton.disabled = false;
            registerButton.style.display = 'none';
            registerStatus.textContent = '';
            registerStatus.className = 'register-status';

            showScreen(gameScreen);

            function updateTimer() {
                if (!gameActive) return;

                const elapsed = performance.now() - startTime;
                const remaining = Math.max(0, GAME_DURATION - elapsed);
                const remainingSeconds = remaining / 1000;

                timerDisplay.textContent = remainingSeconds.toFixed(1);

                if (remainingSeconds <= 1) {
                    timerDisplay.className = 'stat-value timer danger';
                } else if (remainingSeconds <= 3) {
                    timerDisplay.className = 'stat-value timer warning';
                } else {
                    timerDisplay.className = 'stat-value timer';
                }

                if (elapsed > 0) {
                    const cps = (clickCount / (elapsed / 1000)).toFixed(1);
                    liveCpsDisplay.textContent = cps;
                }

                if (remaining > 0) {
                    requestAnimationFrame(updateTimer);
                } else {
                    endGame();
                }
            }

            requestAnimationFrame(updateTimer);
        }

        function endGame() {
            gameActive = false;
            clickButton.disabled = true;
            currentScore = clickCount;

            const finalCps = (clickCount / 10).toFixed(1);
            finalScoreDisplay.textContent = clickCount;
            finalCpsDisplay.textContent = finalCps;

            const bestScore = getBestScore();
            const isNewRecord = clickCount > bestScore;

            if (isNewRecord) {
                setBestScore(clickCount);
                updateBestScoreDisplay();
                newRecordDisplay.classList.add('show');
                registerButton.style.display = 'inline-block';
                createConfetti();
            } else {
                newRecordDisplay.classList.remove('show');
                registerButton.style.display = 'none';
            }

            showScreen(resultScreen);
            updateRankings();
        }

        function createConfetti() {
            const colors = ['#ff6b35', '#fcd34d', '#4ade80', '#60a5fa', '#a78bfa'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        function handleClick(e) {
            if (!gameActive) return;
            e.preventDefault();
            clickCount++;
            clickCountDisplay.textContent = clickCount;
            clickButton.classList.remove('clicked');
            void clickButton.offsetWidth;
            clickButton.classList.add('clicked');
        }

        function showModal() {
            const loginStatus = document.getElementById('loginStatus');
            // 未ログインユーザー用（ログインユーザーはモーダルをスキップ）
            playerNameInput.value = getLastName();
            loginStatus.textContent = '';
            nameModal.classList.add('show');
            setTimeout(() => playerNameInput.focus(), 100);
        }

        function hideModal() {
            nameModal.classList.remove('show');
        }

        startButton.addEventListener('click', startGame);
        retryButton.addEventListener('click', startGame);

        clickButton.addEventListener('mousedown', handleClick);
        clickButton.addEventListener('touchstart', handleClick, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (e.target === clickButton) {
                e.preventDefault();
            }
        }, { passive: false });

        registerButton.addEventListener('click', async () => {
            if (scoreRegistered) return;

            if (currentUser && userProfile) {
                // ログインユーザー: モーダルスキップ、直接登録
                registerButton.disabled = true;
                registerButton.textContent = '登録中...';

                const success = await submitScore(null, currentScore);
                if (success) {
                    scoreRegistered = true;
                    registerStatus.textContent = '登録しました！';
                    registerStatus.className = 'register-status success';
                    await updateRankings(true);
                } else {
                    registerStatus.textContent = '登録に失敗しました';
                    registerStatus.className = 'register-status error';
                    registerButton.disabled = false;
                }
                registerButton.textContent = 'ランキング登録';
            } else {
                // 未ログイン: モーダル表示
                showModal();
            }
        });

        cancelRegisterButton.addEventListener('click', hideModal);

        nameModal.addEventListener('click', (e) => {
            if (e.target === nameModal) {
                hideModal();
            }
        });

        submitScoreButton.addEventListener('click', async () => {
            const name = playerNameInput.value.trim();
            if (!name) {
                playerNameInput.focus();
                return;
            }

            submitScoreButton.disabled = true;
            submitScoreButton.textContent = '登録中...';

            const success = await submitScore(name, currentScore);

            if (success) {
                setLastName(name);
                scoreRegistered = true;
                hideModal();
                registerStatus.textContent = '登録しました！';
                registerStatus.className = 'register-status success';
                registerButton.disabled = true;
                await updateRankings(true); // 強制更新
            } else {
                registerStatus.textContent = '登録に失敗しました';
                registerStatus.className = 'register-status error';
            }

            submitScoreButton.disabled = false;
            submitScoreButton.textContent = '登録';
        });

        playerNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitScoreButton.click();
            }
        });

        updateBestScoreDisplay();
        updateRankings();
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch((err) => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
